# Модели NER-сервиса

Данный сервис использует ансамбль из трех моделей для извлечения именованных сущностей из текста. Архитектура основана на комбинировании результатов различных подходов для повышения точности распознавания.

Скачать модели можно по ссылке: https://disk.yandex.com/d/UFFivjre9lVDkg

Потом их нужно разархивировать и положить в models.

Целевая структура:
 - `models/crf/StackedCRF.joblib`
 - `models/spacy_best/`
 - `models/spacy_full/`

## Архитектура пайплайна

### Основной принцип работы
1. **CRF-модель** (StackedCRF) - основная модель для предсказания
2. **SpaCy Best** - быстрая SpaCy модель с tok2vec эмбеддингами
3. **SpaCy Full** - более точная SpaCy модель с transformer архитектурой
4. **Логика принятия решений** - сравнение результатов и выбор наиболее согласованного

### Алгоритм принятия решений
```python
if predict_crf != predict_spacy_best:
    predict_spacy_full = self._predict_spacy(text, name_model="full")
    if predict_spacy_full == predict_spacy_best:
        result = predict_spacy_best
    else:
        result = predict_crf  # по умолчанию
```

## Модели

### 1. StackedCRF (Основная модель)
**Путь:** `models/crf/StackedCRF.joblib`

**Описание:** Стекинговая CRF модель, использующая ансамбль из трех базовых CRF моделей (A, B, C) и мета-модели для финального предсказания.

**Архитектура:**
- **Базовые модели A, B, C** с разными наборами фичей:
  - **Модель A**: Легкие ортографические/регулярные выражения (без лемматизации, окно=1, без биграмм)
  - **Модель B**: С лексиконами (с лемматизацией, окно=1, с биграммами)
  - **Модель C**: Усиленный контекст (с лемматизацией, окно=2, с биграммами)
- **Мета-модель**: Объединяет предсказания базовых моделей с дополнительными фичами

**Фичи:**
- Токеновые фичи: слово, форма, префиксы/суффиксы, длина, регистр
- Контекстные фичи: окрестные слова в окне ±2
- Лексиконы: бренды, типы, единицы измерения
- Маргинальные вероятности от базовых моделей как фичи для мета-модели

**Параметры CRF:**
- Алгоритм: LBFGS
- C1: 0.05-0.1 (зависит от модели)
- C2: 0.1-0.2 (зависит от модели)
- Максимум итераций: 200-300

**Кросс-валидация:** 5 фолдов для получения out-of-fold предсказаний

### 2. SpaCy Best (Быстрая модель)
**Путь:** `models/spacy_best/`

**Описание:** Оптимизированная SpaCy модель с tok2vec эмбеддингами для быстрого инференса.

**Архитектура:**
- **Tok2Vec**: Многослойный CNN энкодер с MaxoutWindowEncoder
  - Ширина: 128
  - Глубина: 6 слоев
  - Размер окна: 2
  - Maxout pieces: 3
- **NER**: TransitionBasedParser с состоянием NER
  - Скрытая ширина: 128
  - Maxout pieces: 2
  - Использует верхний регистр

**Эмбеддинги:**
- MultiHashEmbed с атрибутами: NORM, PREFIX, SUFFIX, SHAPE
- Размеры таблиц: [5000, 1000, 2500, 2500]
- Включает статические векторы (FastText)

**Производительность:**
- Общая F1: 0.916
- TYPE: F1=0.931, P=0.924, R=0.939
- BRAND: F1=0.872, P=0.875, R=0.869
- VOLUME: F1=0.934, P=0.924, R=0.943
- PERCENT: F1=0.965, P=0.953, R=0.978

### 3. SpaCy Full (Transformer модель)
**Путь:** `models/spacy_full/`

**Описание:** Более точная SpaCy модель с transformer архитектурой для максимального качества.

**Архитектура:**
- **Transformer**: Предобученная transformer модель
- **NER**: TransitionBasedParser с transformer эмбеддингами

**Производительность:**
- Общая F1: 0.811
- TYPE: F1=0.832, P=0.827, R=0.837
- BRAND: F1=0.737, P=0.772, R=0.705
- VOLUME: F1=0.863, P=0.875, R=0.851
- PERCENT: F1=0.948, P=0.937, R=0.960

## Типы сущностей

Модели распознают следующие типы сущностей:

1. **BRAND** - Бренды товаров
2. **TYPE** - Типы товаров
3. **VOLUME** - Объемы и количества
4. **PERCENT** - Проценты

## BIO-разметка

Используется стандартная BIO-схема разметки:
- **B-ENTITY** - начало сущности
- **I-ENTITY** - продолжение сущности
- **O** - не сущность

## Особенности реализации

### Токенизация
- Простая токенизация с сохранением оффсетов
- Поддержка чисел, слов (латиница/кириллица), отдельных символов
- Обработка склеенных чисел с единицами измерения (например, "500мл")

### Фичи для CRF
- **Орфографические**: регистр, длина, префиксы/суффиксы
- **Морфологические**: лемматизация через pymorphy2
- **Контекстные**: окрестные слова, биграммы
- **Лексические**: словари брендов, типов, единиц измерения
- **Регулярные выражения**: для распознавания объемов, процентов, товарных знаков

### Валидация BIO
- Автоматическое исправление некорректных I-тегов без предшествующих B-тегов
- Преобразование в корректную BIO-последовательность

### Постобработка
- Преобразование BIO-тегов в спаны с координатами
- Объединение соседних токенов с одинаковыми тегами
- Фильтрация по допустимому множеству тегов

## Производительность

### Время инференса
1. **CRF** - ~50-100ms (зависит от длины текста)
2. **SpaCy Best** - ~20-50ms
3. **SpaCy Full** - ~100-200ms

### Точность
- **CRF**: Высокая точность на обученных доменах
- **SpaCy Best**: Хороший баланс скорости и качества
- **SpaCy Full**: Максимальная точность, но медленнее

## Использование

```python
# Инициализация пайплайна
pipeline = Pipeline()
await pipeline.initialize()

# Предсказание
result = await pipeline.predict_bio("Текст для анализа")
```

## Зависимости

- **scikit-crfsuite** - для CRF моделей
- **spacy** - для SpaCy моделей
- **pymorphy2** - для морфологического анализа
- **pandas** - для обработки данных
- **numpy** - для численных операций